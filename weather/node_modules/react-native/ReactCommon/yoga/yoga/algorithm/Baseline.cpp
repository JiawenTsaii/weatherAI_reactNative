/*
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */

#include <yoga/Yoga.h>

#include <yoga/algorithm/Align.h>
#include <yoga/algorithm/Baseline.h>
#include <yoga/debug/AssertFatal.h>
#include <yoga/event/event.h>

namespace facebook::yoga {

float calculateBaseline(const yoga::Node* node) {
  if (node->hasBaselineFunc()) {
    Event::publish<Event::NodeBaselineStart>(node);

    const float baseline = node->baseline(
<<<<<<< HEAD
        node->getLayout().measuredDimension(Dimension::Width),
        node->getLayout().measuredDimension(Dimension::Height));
=======
        node->getLayout().measuredDimension(YGDimensionWidth),
        node->getLayout().measuredDimension(YGDimensionHeight));
>>>>>>> d8fbf97a591e21830818fb4b5745c614f0d90615

    Event::publish<Event::NodeBaselineEnd>(node);

    yoga::assertFatalWithNode(
        node,
        !std::isnan(baseline),
        "Expect custom baseline function to not return NaN");
    return baseline;
  }

  yoga::Node* baselineChild = nullptr;
  const size_t childCount = node->getChildCount();
  for (size_t i = 0; i < childCount; i++) {
    auto child = node->getChild(i);
    if (child->getLineIndex() > 0) {
      break;
    }
<<<<<<< HEAD
    if (child->style().positionType() == PositionType::Absolute) {
=======
    if (child->getStyle().positionType() == PositionType::Absolute) {
>>>>>>> d8fbf97a591e21830818fb4b5745c614f0d90615
      continue;
    }
    if (resolveChildAlignment(node, child) == Align::Baseline ||
        child->isReferenceBaseline()) {
      baselineChild = child;
      break;
    }

    if (baselineChild == nullptr) {
      baselineChild = child;
    }
  }

  if (baselineChild == nullptr) {
<<<<<<< HEAD
    return node->getLayout().measuredDimension(Dimension::Height);
  }

  const float baseline = calculateBaseline(baselineChild);
  return baseline + baselineChild->getLayout().position(PhysicalEdge::Top);
}

bool isBaselineLayout(const yoga::Node* node) {
  if (isColumn(node->style().flexDirection())) {
    return false;
  }
  if (node->style().alignItems() == Align::Baseline) {
=======
    return node->getLayout().measuredDimension(YGDimensionHeight);
  }

  const float baseline = calculateBaseline(baselineChild);
  return baseline + baselineChild->getLayout().position[YGEdgeTop];
}

bool isBaselineLayout(const yoga::Node* node) {
  if (isColumn(node->getStyle().flexDirection())) {
    return false;
  }
  if (node->getStyle().alignItems() == Align::Baseline) {
>>>>>>> d8fbf97a591e21830818fb4b5745c614f0d90615
    return true;
  }
  const auto childCount = node->getChildCount();
  for (size_t i = 0; i < childCount; i++) {
    auto child = node->getChild(i);
<<<<<<< HEAD
    if (child->style().positionType() != PositionType::Absolute &&
        child->style().alignSelf() == Align::Baseline) {
=======
    if (child->getStyle().positionType() != PositionType::Absolute &&
        child->getStyle().alignSelf() == Align::Baseline) {
>>>>>>> d8fbf97a591e21830818fb4b5745c614f0d90615
      return true;
    }
  }

  return false;
}

} // namespace facebook::yoga
